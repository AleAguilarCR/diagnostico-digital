{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white text-center">
                <h3>{{ eje.icono }} {{ eje.nombre }}</h3>
                <p class="mb-0">{{ eje.descripcion }}</p>
            </div>
            <div class="card-body">
                <form id="ejeForm">
                    <input type="hidden" id="eje_id" value="{{ eje_id }}">
                    
                    {% for pregunta in preguntas %}
                    {% set pregunta_idx = loop.index0 %}
                    <div class="mb-4 pregunta-container">
                        <h6 class="fw-bold">{{ loop.index }}. {{ pregunta.pregunta }}</h6>
                        
                        {% if pregunta.tipo == 'likert' %}
                        <div class="likert-scale">
                            <div class="row text-center">
                                <div class="col">
                                    <small class="text-muted">Muy bajo/Nunca</small>
                                </div>
                                <div class="col">
                                    <small class="text-muted">Bajo/Raramente</small>
                                </div>
                                <div class="col">
                                    <small class="text-muted">Medio/A veces</small>
                                </div>
                                <div class="col">
                                    <small class="text-muted">Alto/Frecuentemente</small>
                                </div>
                                <div class="col">
                                    <small class="text-muted">Muy alto/Siempre</small>
                                </div>
                            </div>
                            <div class="row mt-2">
                                {% for valor in range(1, 6) %}
                                <div class="col text-center">
                                    <input type="radio" class="btn-check" name="pregunta_{{ pregunta_idx }}" 
                                           id="p{{ pregunta_idx }}_{{ valor }}" value="{{ valor }}">
                                    <label class="btn btn-outline-primary likert-btn" for="p{{ pregunta_idx }}_{{ valor }}">
                                        {{ valor }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        {% elif pregunta.tipo == 'sino' %}
                        <div class="sino-buttons">
                            <div class="row">
                                <div class="col-6">
                                    <input type="radio" class="btn-check" name="pregunta_{{ pregunta_idx }}" 
                                           id="p{{ pregunta_idx }}_si" value="si">
                                    <label class="btn btn-outline-success w-100 sino-btn" for="p{{ pregunta_idx }}_si">
                                        <i class="fas fa-check me-2"></i>Sí
                                    </label>
                                </div>
                                <div class="col-6">
                                    <input type="radio" class="btn-check" name="pregunta_{{ pregunta_idx }}" 
                                           id="p{{ pregunta_idx }}_no" value="no">
                                    <label class="btn btn-outline-danger w-100 sino-btn" for="p{{ pregunta_idx }}_no">
                                        <i class="fas fa-times me-2"></i>No
                                    </label>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <hr>
                    {% endfor %}
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="/dashboard?eje_completado={{ eje_id }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left me-2"></i>Volver
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check me-2"></i>Enviar Evaluación
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Resultados -->
<div class="modal fade" id="resultadosModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-chart-bar me-2"></i>Resultados: <span id="ejeNombreResultado"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <h2>Puntaje Obtenido: <span id="puntajeResultado" class="text-primary fw-bold" style="font-size: 2.5rem;"></span><span class="fw-bold" style="font-size: 2.5rem;">/5</span></h2>
                    <div id="nivelIndicador" class="mt-3"></div>
                </div>
                
                <h5>Recomendaciones Personalizadas:</h5>
                <div id="recomendacionesTexto" class="bg-light p-3 rounded"></div>
                
                <div class="mt-4 text-center">
                    <button type="button" class="btn btn-primary me-2" id="descargarPDF">
                        <i class="fas fa-file-pdf me-2"></i>Descargar PDF
                    </button>
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="window.location.href='/dashboard'">
                        <i class="fas fa-home me-2"></i>Volver al Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('ejeForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const respuestas = [];
    const ejeId = document.getElementById('eje_id').value;
    
    // Recopilar respuestas
    {% for pregunta in preguntas %}
    const pregunta{{ loop.index0 }} = formData.get('pregunta_{{ loop.index0 }}');
    if (pregunta{{ loop.index0 }}) {
        respuestas.push({
            pregunta: "{{ pregunta.pregunta }}",
            tipo: "{{ pregunta.tipo }}",
            valor: pregunta{{ loop.index0 }}
        });
    }
    {% endfor %}
    
    // Validar que todas las preguntas estén respondidas
    if (respuestas.length < {{ preguntas|length }}) {
        alert('Por favor responda todas las preguntas antes de enviar.');
        
        // Resaltar preguntas sin responder sin afectar las respuestas
        document.querySelectorAll('.pregunta-container').forEach((container, index) => {
            const radios = container.querySelectorAll('input[type="radio"]');
            const answered = Array.from(radios).some(radio => radio.checked);
            
            if (!answered) {
                container.style.border = '2px solid #dc3545';
                container.style.backgroundColor = '#fff5f5';
            }
        });
        
        // Scroll a la primera pregunta sin responder
        const firstUnanswered = document.querySelector('.pregunta-container[style*="border: 2px solid"]');
        if (firstUnanswered) {
            firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        return;
    }
    
    // Mostrar loading
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
    submitBtn.disabled = true;
    
    try {
        const response = await fetch('/evaluar_eje', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                eje_id: parseInt(ejeId),
                respuestas: respuestas
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Mostrar resultados en modal
            document.getElementById('puntajeResultado').textContent = result.puntaje;
            document.getElementById('ejeNombreResultado').textContent = result.eje_nombre;
            document.getElementById('recomendacionesTexto').innerHTML = result.recomendaciones.replace(/\n/g, '<br>');
            
            // Mostrar indicador de nivel
            const indicador = document.getElementById('nivelIndicador');
            let nivelTexto, colorClass, icono;
            
            switch(result.puntaje) {
                case 1:
                    nivelTexto = 'Nivel Básico';
                    colorClass = 'text-danger';
                    icono = 'fas fa-circle';
                    break;
                case 2:
                    nivelTexto = 'Nivel Inicial';
                    colorClass = 'text-warning';
                    icono = 'fas fa-circle';
                    break;
                case 3:
                    nivelTexto = 'Nivel Intermedio';
                    colorClass = 'text-warning';
                    icono = 'fas fa-circle';
                    break;
                case 4:
                    nivelTexto = 'Nivel Avanzado';
                    colorClass = 'text-success';
                    icono = 'fas fa-circle';
                    break;
                case 5:
                    nivelTexto = 'Nivel Experto';
                    colorClass = 'text-success';
                    icono = 'fas fa-circle';
                    break;
            }
            
            indicador.innerHTML = `<i class="${icono} ${colorClass} fa-2x"></i><br><strong class="${colorClass}">${nivelTexto}</strong>`;
            
            // Configurar botón de descarga PDF
            document.getElementById('descargarPDF').onclick = function() {
                window.open(`/generar_pdf/${ejeId}`, '_blank');
            };
            
            // Configurar botón volver al dashboard
            document.querySelector('#resultadosModal .btn-success').onclick = function() {
                window.location.href = `/dashboard?eje_completado=${ejeId}`;
            };
            
            // Mostrar modal
            new bootstrap.Modal(document.getElementById('resultadosModal')).show();
        } else {
            alert('Error al procesar la evaluación. Intente nuevamente.');
        }
    } catch (error) {
        alert('Error de conexión. Intente nuevamente.');
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

// Cargar respuestas anteriores
{% if respuestas_anteriores %}
const respuestasAnteriores = {{ respuestas_anteriores|tojson }};
window.addEventListener('load', function() {
    for (const [key, value] of Object.entries(respuestasAnteriores)) {
        const input = document.querySelector(`input[name="${key}"][value="${value}"]`);
        if (input) {
            input.checked = true;
            const container = input.closest('.pregunta-container');
            if (container) {
                container.style.border = '';
                container.style.backgroundColor = '';
            }
        }
    }
});
{% endif %}

// Efectos visuales para botones
document.querySelectorAll('.likert-btn, .sino-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Agregar efecto de selección
        this.style.transform = 'scale(1.05)';
        setTimeout(() => {
            this.style.transform = 'scale(1)';
        }, 150);
    });
});
</script>
{% endblock %}